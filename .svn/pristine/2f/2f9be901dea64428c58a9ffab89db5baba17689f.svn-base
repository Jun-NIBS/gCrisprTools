---
output: html_document
params:
  eset: !r NULL
  fit: !r NULL
  classVariable: !r NULL
  results: !r NULL
  annotation: !r NULL
  sn: !r NULL 
---

#Contrast: `r dimnames(params$fit$contrasts)$Contrasts`

This is a report visualizing the overall dynamics of a single contrast in a pooled CRISPR-based screening experiment. See the vignettes folder of the `gCrisprTools` R package for further discussion of the proper analysis and interpretation of these experiments. For analysts, the manual pages of the various functions provide further detail about the analytical approaches employed and computational considerations relevant to their interpretation. 

###Raw gRNA Read Counts

Sample libraries may be undersequenced if the raw number of read counts per gRNA are low, and PCR artifacts may be present if the sample contains a subset of extremely abundant guides or the gRNA distribution contains multiple modes. In most well-executed experiments the majority of gRNAs in the control samples will form a tight distribution around some reasonably high average read count (hundreds of reads, *Y* axis). Excessively low raw count values can compromise normalization steps and subsequent estimation of gRNA levels, which is typically a problem in screens where identification of disproportionately depleted gRNAs is important. 

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height=10, fig.width=10}
ct.rawCountDensities(params$eset, params$classVariable)
```

###Library-level Distortion of gRNA Abundances

Pooled CRISPR screens are fundamentally dynamic experiments, in which the measured abundance of a particular gRNA is fundamentally dependent on the scale of selection observed throughout the rest of the screen. In general, rigorous statistical methods perform well in screens where most cells survive the selection event and the gRNA distributions remain relatively stable throughout the experiment; more heuristic approaches tend to work better in screens where most cells die and the resulting library only contains a small subset of gRNAs of extremely high abundance. The primary goal of this section is to determine the extent to which selection has distorted your gRNA library to guide downstream analyses.

#####Ranked and Scaled gRNA Abundance Distributions 
Strong selection in a CRISPR screen will distort the gRNAs such that the "slope" of the middle of the distribution changes relative to what is observed in the control samples. This can lead to spurious inferences of gRNA depletion in some cases, and it may be useful to correct this with the `ct.normalizeBySlope()` function in the `gCrisprTools` R package prior to downstream analyses. Alternatively, experiments involving treatments where most cells are affected may have failed if library-level distortion is not readily apparent. The locations of nontargeting control guides are indicated as diamonds along each distribution.

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height=10, fig.width=10}
ct.gRNARankByReplicate(params$eset, params$classVariable, controls = TRUE, params$annotation)  
```

#####Cumulative Target-level Read Abundance
A simple way to quantify the extent of distortion in a CRISPR screen is to observe the proportion of reads within each library that are derived from gRNA cassettes targeting each genomic element. By ranking the targets by their abundance within the library (*X* axis) and plotting the cumulative proportion of reads that the top *N* targets represent (*Y* axis), we can tell if the treatment libraries basically only target a few genes or if most of the cells made it through the selection step. 

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height=10, fig.width=10}
ct.guideCDF(params$eset, sampleNames = params$sn, plotType = "Target", params$annotation)
```

###Nontargeting Control Guides

The behavior of nontargeting control guides can give some sense of the consistency of the gRNA abundances within experimental cultures and the likely effect of normalization on the gRNA abundance estimation. Note that it is not necessarily critical that the abundances of nontargeting gRNAs remain superficially identical across treatments, but extremely large changes may indicate that individual gRNA levels are not likely to be well estimated. 

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height=10, fig.width=10}
ct.viewControls(params$eset, params$annotation, order.by = params$classVariable, normalize = FALSE) 
ct.viewControls(params$eset, params$annotation, order.by = params$classVariable, normalize = TRUE)
```

###Most Variable Guides, as a Proportion of the Libraries

In experiments that include highly distorted libraries, it can be useful to identify the genes or gRNAs that change the most across the experiment as a heuristic way of identifying gRNAs of interest in situations where standard statistical approaches are not likely to function well. Note that the indicated gRNAs are the most variable across all contrasts in the experiment.

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height=10, fig.width=10}
ct.stackGuides(params$eset, sample.ordering = params$classVariable, plotType = "Target", annotation = params$annotation)
ct.stackGuides(params$eset, sample.ordering = params$classVariable, plotType = "gRNA", annotation = params$annotation, nguides = 40)
```

###Top Signals of Target Enrichment and Depletion

Below are plots indicating the targets with the most evidence for enrichment and depletion within the indicated contrast. Genes are ranked by aggregating the signal for depletion or enrichment across all gRNAs targeting the corresponding element. Briefly, individual gRNAs are assigned a P-value quantifying the evidence for enrichment or depletion within the contrast using a linear model. The P-values of all the gRNAs in the experiment are transformed into a ranking, and genes are assigned a score based on the distribution of the ranks of the P-values observed among the guides targeting it, ignoring gRNAs with P-values above a nominal significance threshold (*P*= 0.05 by default). These scores are transformed into a P-value via permutation; genes targeted by lots of guides with the highest overall evidence for abundance changes will be top ranked. Genes with identical P-values are ordered by their median gRNA abundance change within the contrast (log2 fold change within the framework of the linear model). This method of gRNA signal aggregation is identical to the method employed by the MAGeCK algorithm (Li et al., *Genome Research* 2014). 

Within each plot, candidates are ordered by the evidence for enrichment or depletion. Each gRNA targeting the gene is plotted as a point, with the estimated log2 fold change  indicated on the *Y*-axis and the standard deviation of the estimate shown as a gray bar. 


```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height= 5, fig.width= 10}
enrich <- ct.topTargets(params$fit, params$results, params$annotation, ntargets = 20, enrich = TRUE)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height= 5, fig.width= 10}
deplete <- ct.topTargets(params$fit, params$results, params$annotation, ntargets = 20, enrich = FALSE)
```



