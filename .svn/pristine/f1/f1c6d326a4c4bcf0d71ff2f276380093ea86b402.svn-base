##' @title Display the log2 fold change estimates of the guides targeting the top candidates in a crispr screen
##' @description This is a function for displaying the top candidates from a crispr screen, using the information summarized in the 
##' corresponding \code{expressionset} and the output from \code{ct.generateResults()}. The results are plotted as two figures, 
##' indicating the top \code{guides} upregulated and downregulated guides. 
##' @param fit An object of class \code{MArrayLM} containing, at minimum, a \code{t} slot with t-statistics from the comparison, 
##' a \code{df.residual} slot with the corresponding residuals fo the model fits, and an \code{Amean} slot with the respective mean abundances. 
##' @param annotation An annotation file for the experiment, usually extracted with \code{ep.load.annot()} in ExpressionPlot. gRNAs are annotated by 
##' row, and must minimally contain columns \code{geneSymbol} and \code{geneID}.
##' @param RRAalphaCutoff A nominal p-value cutoff to use when defining gRNAs with significantly altered abundance during the RRAa aggregation step.  
##' @param permutations The number of permutations to use during the RRAa aggregation step.  
##' @return A dataframe containing gRNA-level and gene-level statistics 
##' @author Russell Bainer
##' @export

ct.resultView <- function(fit, annotation, ntargets = 10){
  require(Biobase)
  require(limma)

  pvals <- ct.DirectionalTests(fit)
  key <- ct.buildKeyFromAnnotation(annotation)
  geneP.enrichment <- ct.mcRRAaPvals(as.matrix(pvals[,2]), g.key = key, alpha = RRAalphaCutoff, multicore = multi.core)
  geneP.depletion <- ct.mcRRAaPvals(as.matrix(pvals[,1]), g.key = key, alpha = RRAalphaCutoff, multicore = multi.core)

  geneQ.enrichment <- p.adjust(geneP.enrichment, method = "fdr")
  geneQ.depletion <- p.adjust(geneP.depletion, method = "fdr")

  annotFields <- c("symbol", "target", "geneID", "geneSymbol")  
  if(!all(annotFields %in% names(ann))){
    warning(paste("Some expected columns are not present in the supplied annotation file.", call. = FALSE))
    annotFields <- intersect(annotFields, names(ann))
    message(paste("Only the following information will be included in the output:", paste(annotFields, collapse = ',')))  
  } 

  #make the DF
  summaryDF <- ann[,annotFields]
  summaryDF["Avg Norm gRNA Abundance (log2)"] <- fit$Amean[row.names(summaryDF)]
  summaryDF["gRNA Depletion P"] <- signif(pvals[row.names(summaryDF),1], 5)
  summaryDF["gRNA Depletion Q"] <- signif(p.adjust(pvals[,1], "fdr")[row.names(summaryDF)], 5)
  summaryDF["gRNA Enrichment P"] <- signif(pvals[row.names(summaryDF),2], 5)
  summaryDF["gRNA Enrichment Q"] <- signif(p.adjust(pvals[,2], "fdr")[row.names(summaryDF)], 5)
  summaryDF["Gene-level Enrichment P"] <- geneP.enrichment[summaryDF$geneSymbol]
  summaryDF["Gene-level Enrichment Q"] <- geneQ.enrichment[summaryDF$geneSymbol]
  summaryDF["Gene-level Depletion P"] <- geneP.depletion[summaryDF$geneSymbol]
  summaryDF["Gene-level Depletion Q"] <- geneQ.depletion[summaryDF$geneSymbol]

  summaryDF <- summaryDF[order(summaryDF[,"Gene-level Enrichment P"], decreasing = FALSE),]
  
  return(summaryDF)
}
  
  
  
  

  
  
  
  
  
  
  
  
  
  
  
  
  
  
  



